"use client";
import { useEffect, useRef, useState } from "react";
import axios from "axios";
import styles from "./chatbotPopup.module.css";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";

type Role = "user" | "model";

interface ChatMessageHistory {
  role: Role;
  parts: { text: string }[];
}


export default function ChatbotPopup() {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<{ sender: string; text: string }[]>([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [history, setHistory] = useState<ChatMessageHistory[]>([]);


  const messagesEndRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
    }
  }, [messages, loading]);

  const sendMessage = async () => {
    if (!input.trim()) return;

    const userText = input.trim();

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ng∆∞·ªùi d√πng
    setMessages((prev) => [...prev, { sender: "user", text: userText }]);
    setInput("");
    setLoading(true);


    // C·∫≠p nh·∫≠t history ph√≠a frontend
    const updatedHistory: ChatMessageHistory[] = [
      ...history,
      { role: "user", parts: [{ text: userText }] },
    ];


    try {
      const res = await axios.post("http://localhost:8000/v1/chat/generate-response", {
        prompt: userText,
        history: updatedHistory,
      });

      const botText = res.data.response;

      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã bot
      setMessages((prev) => [...prev, { sender: "bot", text: botText }]);

      // L∆∞u l·∫°i history k√®m ph·∫£n h·ªìi c·ªßa bot
      setHistory([
        ...updatedHistory,
        { role: "model", parts: [{ text: botText }] },
      ]);

    } catch (err) {
      setMessages((prev) => [
        ...prev,
        { sender: "bot", text: "‚ö†Ô∏è C√≥ l·ªói x·∫£y ra khi g·ªçi AI" },
      ]);
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      <div className={styles.chatIcon} onClick={() => setIsOpen(!isOpen)}>
        üí¨
      </div>

      {isOpen && (
        <div className={styles.chatWindow}>
          <div className={styles.header}>
            Chat v·ªõi The Moon AI
            <button onClick={() => setIsOpen(false)}>x</button>
          </div>

          <div className={styles.messages}>
            {messages.map((msg, i) => (
              <div
                key={i}
                className={`${styles.message} ${msg.sender === "user" ? styles.user : styles.bot
                  }`}
              >
                {msg.sender === "bot" ? (
                  <ReactMarkdown remarkPlugins={[remarkGfm]}>
                    {msg.text}
                  </ReactMarkdown>
                ) : (
                  <span>{msg.text}</span>
                )}
              </div>
            ))}
            {loading && <div className={styles.bot}>ƒêang tr·∫£ l·ªùi...</div>}
            <div ref={messagesEndRef} />
          </div>

          <div className={styles.inputArea}>
            <input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && sendMessage()}
              placeholder="Nh·∫≠p tin nh·∫Øn..."
            />
            <button onClick={sendMessage}>G·ª≠i</button>
          </div>
        </div>
      )}
    </>
  );
}
